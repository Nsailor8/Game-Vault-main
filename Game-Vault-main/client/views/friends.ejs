<!DOCTYPE html>
<html lang="en">
<%- include('partials/head', { pageTitle: 'Friends' }) %>
<body>
  <%- include('partials/header') %>

  <div class="container">
    <main class="main-content">
      <!-- Friends Section -->
      <section id="friendsSection" class="content-section active">
        <div class="section-header">
          <h2>Friends</h2>
        </div>
        <div class="friends-content">
          <!-- Add Friend Section -->
          <div class="add-friend-section">
            <h3>Add Friend</h3>
            <div class="add-friend-form">
              <input type="text" id="friendUsernameInput" placeholder="Enter username..." class="form-input">
              <button id="sendFriendRequestBtn" class="btn btn-primary">Send Request</button>
            </div>
          </div>

          <!-- Friends List -->
          <div class="friends-list">
            <h3>Friends (<span id="friendsCount">0</span>)</h3>
            <div id="friendsList" class="list-container">
              <!-- Friends will be dynamically populated by updateFriends() -->
            </div>
          </div>

          <!-- Wishlist Section -->
          <div class="wishlist-section">
            <h3>Wishlist</h3>
            <div id="wishlistList" class="list-container">
              <!-- Wishlist items will populate here -->
            </div>
          </div>

          <!-- Reviews Section -->
          <div class="reviews-section">
            <h3>Reviews</h3>
            <div id="reviewsList" class="list-container">
              <!-- Review items will populate here -->
            </div>
          </div>

          <!-- Received Requests -->
          <div class="received-requests">
            <h3>Friend Requests (<span id="receivedRequestsCount">0</span>)</h3>
            <div id="receivedRequests" class="list-container">
              <div class="empty-state">
                <i class="fas fa-user-plus"></i>
                <h3>No friend requests</h3>
                <p>You'll see friend requests here when people want to add you!</p>
              </div>
            </div>
          </div>

          <!-- Sent Requests -->
          <div class="sent-requests">
            <h3>Sent Requests (<span id="sentRequestsCount">0</span>)</h3>
            <div id="sentRequests" class="list-container">
              <div class="empty-state">
                <i class="fas fa-paper-plane"></i>
                <h3>No sent requests</h3>
                <p>Your sent friend requests will appear here!</p>
              </div>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <%- include('partials/loginModal') %>

  <!-- Friend Profile Modal -->
  <div id="friendProfileModal" class="modal" style="display: none;">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2 id="friendUsername">Friend Name</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Friend profile will load here.</p>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Friends page - DOM Content Loaded');

      const modal = document.getElementById('friendProfileModal');
      const modalClose = modal.querySelector('.close');
      const friendUsernameElem = document.getElementById('friendUsername');
      const modalBody = modal.querySelector('.modal-body');

      // Function to open modal with friend details
      const openFriendModal = (friend) => {
        friendUsernameElem.textContent = friend.username;
        modalBody.innerHTML = `
          <p>Friend profile will load here.</p>
          <p>Username: ${friend.username}</p>
          <p>Friends since: ${new Date(friend.friendshipDate).toLocaleDateString()}</p>
          ${friend.bio ? `<p class="friend-bio">${friend.bio}</p>` : ''}
        `;
        modal.style.display = 'block';
      };

      // Close modal
      modalClose.addEventListener('click', () => modal.style.display = 'none');
      window.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });

      // Wait for app initialization
      if (window.app) {
        await window.app.checkAuthStatus();
        if (window.app.currentUser) {
          // Call the already-defined updateFriends()
          window.app.updateFriends();

          // Attach modal function globally so displayFriends() can use it
          window.app.viewFriendProfile = openFriendModal;
        }
      } else {
        // Fallback if app isnâ€™t ready yet
        setTimeout(async () => {
          if (window.app && window.app.currentUser) {
            window.app.updateFriends();
            window.app.viewFriendProfile = openFriendModal;
          }
        }, 500);
      }
    });
  </script>
</body>
</html>
