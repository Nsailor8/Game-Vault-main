<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Vault - Home</title>
  <link rel="stylesheet" href="/styles.css?v=2">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Header Partial -->
    <%- include('partials/header') %>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Trending Games Section -->
      <section class="section">
        <div class="section-header">
          <h2>Trending Games</h2>
          <p>Most popular and highly rated games</p>
        </div>
        <div id="trendingList" class="games-grid">
          <% if (trendingGames && trendingGames.length) { %>
            <% trendingGames.forEach(function(game) { %>
              <div class="game-card-simple" onclick="if(window.app) window.app.viewGameDetails(<%= game.id %>)">
                <div class="game-image-simple" style="cursor: pointer;">
                  <% if (game.background_image || game.backgroundImage) { %>
                    <img src="<%= game.background_image || game.backgroundImage %>" alt="<%= game.name %>" class="game-image" loading="lazy">
                  <% } else { %>
                    <div class="no-image">
                      <i class="fas fa-gamepad"></i>
                    </div>
                  <% } %>
                  <% if (game.rating || game.metacritic) { %>
                    <div class="game-card-rating">
                      <% if (game.rating) { %>
                        <span class="rating-badge"><i class="fas fa-star"></i> <%= game.rating.toFixed(1) %></span>
                      <% } %>
                      <% if (game.metacritic) { %>
                        <span class="metacritic-badge">M: <%= game.metacritic %></span>
                      <% } %>
                    </div>
                  <% } %>
                </div>
                <div class="game-name-simple" style="cursor: pointer;">
                  <h3 class="game-title-simple"><%= game.name %></h3>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="empty-state">
              <i class="fas fa-fire"></i>
              <h3>No trending games available</h3>
              <p>Check back later for the latest trending games!</p>
            </div>
          <% } %>
        </div>
      </section>

      <!-- Recently Added Section -->
      <section class="section">
        <div class="section-header">
          <h2>Recently Released</h2>
          <p>Latest games that just hit the market</p>
        </div>
        <div id="recentList" class="games-grid">
          <% if (recentGames && recentGames.length) { %>
            <% recentGames.forEach(function(game) { %>
              <div class="game-card-simple" onclick="if(window.app) window.app.viewGameDetails(<%= game.id %>)">
                <div class="game-image-simple" style="cursor: pointer;">
                  <% if (game.background_image || game.backgroundImage) { %>
                    <img src="<%= game.background_image || game.backgroundImage %>" alt="<%= game.name %>" class="game-image" loading="lazy">
                  <% } else { %>
                    <div class="no-image">
                      <i class="fas fa-gamepad"></i>
                    </div>
                  <% } %>
                  <% if (game.rating || game.metacritic) { %>
                    <div class="game-card-rating">
                      <% if (game.rating) { %>
                        <span class="rating-badge"><i class="fas fa-star"></i> <%= game.rating.toFixed(1) %></span>
                      <% } %>
                      <% if (game.metacritic) { %>
                        <span class="metacritic-badge">M: <%= game.metacritic %></span>
                      <% } %>
                    </div>
                  <% } %>
                </div>
                <div class="game-name-simple" style="cursor: pointer;">
                  <h3 class="game-title-simple"><%= game.name %></h3>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="empty-state">
              <i class="fas fa-clock"></i>
              <h3>No recent games available</h3>
              <p>Check back later for the latest releases!</p>
            </div>
          <% } %>
        </div>
      </section>
    </main>

    <!-- Footer Partial -->
    <%- include('partials/footer') %>
  </div>

  <!-- Login Modal -->
  <%- include('partials/loginModal') %>

  <!-- App Script -->
  <script src="/app.js?v=2"></script>
  <script>
    // Ensure layout is correct immediately on page load
    (function() {
      // Hide nav if user section is visible (before JS loads)
      const userSection = document.getElementById('userSection');
      const nav = document.querySelector('.nav');
      if (userSection && userSection.style.display !== 'none') {
        if (nav) {
          nav.classList.add('user-hidden');
          nav.style.display = 'none';
        }
      }
    })();
    
    // Load games asynchronously after page loads
    document.addEventListener('DOMContentLoaded', async function() {
      const trendingList = document.getElementById('trendingList');
      const recentList = document.getElementById('recentList');
      
      // Show loading state
      if (trendingList) {
        trendingList.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h3>Loading trending games...</h3></div>';
      }
      if (recentList) {
        recentList.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h3>Loading recent games...</h3></div>';
      }
      
      // Function to render games
      function renderGames(container, games) {
        if (!container || !games || games.length === 0) {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-fire"></i><h3>No games available</h3><p>Check back later!</p></div>';
          return;
        }
        
        container.innerHTML = games.map(game => {
          let imageUrl = game.background_image || game.backgroundImage || '';
          // Ensure URL is absolute
          if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://') && !imageUrl.startsWith('//')) {
            imageUrl = 'https://' + imageUrl.replace(/^\/+/, '');
          }
          console.log(`[Game Image] ${game.name}:`, imageUrl || 'NO IMAGE URL');
          const ratingHtml = game.rating ? `<span class="rating-badge"><i class="fas fa-star"></i> ${game.rating.toFixed(1)}</span>` : '';
          const metacriticHtml = game.metacritic ? `<span class="metacritic-badge">M: ${game.metacritic}</span>` : '';
          const ratingSection = (game.rating || game.metacritic) ? `<div class="game-card-rating">${ratingHtml}${metacriticHtml}</div>` : '';
          
          const gameId = game.id || game.appid || game.steam_id || 0;
          const escapedName = game.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
          const escapedUrl = imageUrl ? imageUrl.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
          
          return `
            <div class="game-card-simple" onclick="if(window.app) window.app.viewGameDetails(${gameId})">
              <div class="game-image-simple" style="cursor: pointer;">
                ${imageUrl ? `<img src="${escapedUrl}" alt="${escapedName}" class="game-image" loading="lazy" crossorigin="anonymous"><div class="no-image" style="display: none;"><i class="fas fa-gamepad"></i></div>` : '<div class="no-image"><i class="fas fa-gamepad"></i></div>'}
                ${ratingSection}
              </div>
              <div class="game-name-simple" style="cursor: pointer;">
                <h3 class="game-title-simple">${game.name}</h3>
              </div>
            </div>
          `;
        }).join('');
        
        // Ensure all images are visible after rendering
        setTimeout(() => {
          const images = container.querySelectorAll('.game-image');
          images.forEach(img => {
            if (img.complete && img.naturalHeight > 0) {
              console.log('[Image Verified]', img.alt, 'loaded successfully');
              img.style.display = 'block';
              img.style.visibility = 'visible';
              img.style.opacity = '1';
              img.style.zIndex = '10';
            } else {
              img.addEventListener('load', function() {
                console.log('[Image Loaded]', this.alt);
                this.style.display = 'block';
                this.style.visibility = 'visible';
                this.style.opacity = '1';
                this.style.zIndex = '10';
              });
              img.addEventListener('error', function() {
                console.error('[Image Error]', this.alt, this.src);
                this.style.display = 'none';
                const noImage = this.nextElementSibling;
                if (noImage && noImage.classList.contains('no-image')) {
                  noImage.style.display = 'flex';
                }
              });
            }
          });
        }, 100);
      }
      
      // Fetch trending games
      try {
        const trendingResponse = await fetch('/api/games/trending?limit=8');
        if (trendingResponse.ok) {
          const trendingData = await trendingResponse.json();
          if (trendingData.success && trendingData.games && trendingData.games.length > 0) {
            renderGames(trendingList, trendingData.games);
          } else {
            trendingList.innerHTML = '<div class="empty-state"><i class="fas fa-fire"></i><h3>No trending games available</h3><p>Check back later for the latest trending games!</p></div>';
          }
        }
      } catch (error) {
        console.error('Error loading trending games:', error);
        trendingList.innerHTML = '<div class="empty-state"><i class="fas fa-fire"></i><h3>Error loading trending games</h3><p>Please refresh the page.</p></div>';
      }
      
      // Fetch recent games
      try {
        const recentResponse = await fetch('/api/games/recent?limit=8');
        if (recentResponse.ok) {
          const recentData = await recentResponse.json();
          if (recentData.success && recentData.games && recentData.games.length > 0) {
            renderGames(recentList, recentData.games);
          } else {
            recentList.innerHTML = '<div class="empty-state"><i class="fas fa-clock"></i><h3>No recent games available</h3><p>Check back later for the latest releases!</p></div>';
          }
        }
      } catch (error) {
        console.error('Error loading recent games:', error);
        recentList.innerHTML = '<div class="empty-state"><i class="fas fa-clock"></i><h3>Error loading recent games</h3><p>Please refresh the page.</p></div>';
      }
    });
  </script>
</body>
</html>
