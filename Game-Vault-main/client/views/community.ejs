<!DOCTYPE html>
<html lang="en">
  <%- include('partials/head', { pageTitle: 'Community' }) %>
<body>
  <%- include('partials/header', { activePage: 'community' }) %>

  <div class="container">
    <main class="main-content">
      <section id="communitySection" class="content-section active community-section">
        <div class="section-header">
          <div class="section-title-group">
            <h2>Community</h2>
            <p class="section-subtitle">Discuss games, share experiences, and connect with fellow gamers.</p>
          </div>
          <div class="section-actions">
            <button id="createPostBtn" class="btn btn-primary" onclick="
              if(typeof window.showCreatePostModal === 'function') { 
                window.showCreatePostModal(); 
              } else { 
                console.log('Waiting for app.js to load...');
                setTimeout(() => {
                  if(typeof window.showCreatePostModal === 'function') {
                    window.showCreatePostModal();
                  } else {
                    console.error('showCreatePostModal function still not available after delay');
                    alert('Please refresh the page and try again.');
                  }
                }, 500);
              } 
              return false;
            ">
              <i class="fas fa-plus"></i> Create Post
            </button>
          </div>
        </div>

        <!-- Filters & Controls -->
        <div class="community-toolbar">
          <div class="toolbar-left">
            <div class="search-input">
              <i class="fas fa-search"></i>
              <input type="text" id="communitySearch" placeholder="Search posts or games...">
            </div>
            <div class="filter-group">
              <label class="sr-only" for="communityCategory">Category</label>
              <select id="communityCategory" class="filter-control">
                <option value="all" selected>All Categories</option>
                <option value="general">General</option>
                <option value="game-discussion">Game Discussion</option>
                <option value="help">Help</option>
                <option value="off-topic">Off-Topic</option>
                <option value="announcements">Announcements</option>
              </select>

              <label class="sr-only" for="communitySort">Sort</label>
              <select id="communitySort" class="filter-control">
                <option value="newest" selected>Newest</option>
                <option value="oldest">Oldest</option>
                <option value="most-liked">Most Liked</option>
                <option value="most-viewed">Most Viewed</option>
                <option value="most-commented">Most Commented</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Posts Container -->
        <div id="communityPostsContainer" class="community-posts-container">
          <div class="loading-spinner" id="communityLoading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading posts...</p>
          </div>
        </div>

        <!-- Pagination -->
        <div id="communityPagination" class="community-pagination"></div>
      </section>
    </main>
  </div>

  <!-- Create Post Modal -->
  <div id="createPostModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="app.closeCreatePostModal()">&times;</span>
      <h2>Create New Post</h2>
      <form id="createPostForm">
        <div class="form-group">
          <label for="postTitle">Title *</label>
          <input type="text" id="postTitle" name="title" required minlength="3" maxlength="200" placeholder="Enter post title...">
        </div>
        <div class="form-group">
          <label for="postCategory">Category *</label>
          <select id="postCategory" name="category" required>
            <option value="general">General</option>
            <option value="game-discussion">Game Discussion</option>
            <option value="help">Help</option>
            <option value="off-topic">Off-Topic</option>
            <option value="announcements">Announcements</option>
          </select>
        </div>
        <div class="form-group">
          <label for="postGameTitle">Game (Optional)</label>
          <input type="text" id="postGameTitle" name="gameTitle" placeholder="Enter game name if discussing a specific game...">
        </div>
        <div class="form-group">
          <label for="postContent">Content *</label>
          <textarea id="postContent" name="content" required minlength="10" maxlength="10000" rows="10" placeholder="Write your post content here..."></textarea>
          <div class="char-count">
            <span id="postCharCount">0</span> / 10000 characters
          </div>
        </div>
        <div class="form-group">
          <label for="postTags">Tags (Optional)</label>
          <input type="text" id="postTags" name="tags" placeholder="Enter tags separated by commas...">
          <small>Example: multiplayer, strategy, indie</small>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="app.closeCreatePostModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Post</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Post Details Modal -->
  <div id="postDetailsModal" class="modal">
    <div class="modal-content post-details-content">
      <span class="close" onclick="app.closePostDetailsModal()">&times;</span>
      <div id="postDetailsContainer"></div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script src="/app.js?v=2"></script>
  <script>
    // Initialize community page
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait for app to initialize and check auth status
      // Don't reset user state if check fails - preserve existing session
      if (window.app) {
        try {
          await window.app.checkAuthStatus();
          await window.app.initializeCommunityPage();
        } catch (error) {
          console.error('Error initializing community page:', error);
          // Don't reset UI if check fails - user might still be logged in
          // Only initialize if we successfully got a user
          if (window.app && window.app.currentUser) {
            await window.app.initializeCommunityPage();
          }
        }
      } else {
        setTimeout(async () => {
          if (window.app) {
            try {
              await window.app.checkAuthStatus();
              await window.app.initializeCommunityPage();
            } catch (error) {
              console.error('Error initializing community page (delayed):', error);
              // Don't reset UI if check fails - user might still be logged in
              if (window.app && window.app.currentUser) {
                await window.app.initializeCommunityPage();
              }
            }
          }
        }, 500);
      }
    });
  </script>
</body>
</html>

