<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - Game Vault</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <%- include('partials/header', { activePage: 'search', homeLink: '/' }) %>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Search Results Section -->
            <section class="section">
                <div class="section-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <h2 id="searchTitle">üîç Search Results</h2>
                            <p id="searchSubtitle">Loading search results...</p>
                        </div>
                        <button class="btn btn-secondary" onclick="goBack()" style="margin-left: auto;">
                            <i class="fas fa-arrow-left"></i> Back to Home
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="searchLoading" class="search-loading" style="display: block;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Searching games...</p>
                </div>

                <!-- Error State -->
                <div id="searchError" class="search-error" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Search Error</h3>
                    <p id="searchErrorMessage"></p>
                    <button class="btn btn-primary" onclick="retrySearch()">Try Again</button>
                </div>

                <!-- Mock Data Notice -->
                <div id="mockDataNotice" class="mock-data-notice" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Loading:</strong> The Steam game database is being loaded. If you see sample data, the Steam app list is still loading (this may take a moment on first use).
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="games-grid" style="display: none;">
                    <!-- Game cards will be populated here -->
                </div>

                <!-- Pagination -->
                <div id="searchPagination" class="search-pagination" style="display: none; margin-top: 30px; text-align: center;">
                    <!-- Pagination will be populated here -->
                </div>

                <!-- No Results -->
                <div id="noResults" class="empty-state" style="display: none;">
                    <i class="fas fa-search"></i>
                    <h3>No Games Found</h3>
                    <p>Try a different search term</p>
                    <button class="btn btn-primary" onclick="goBack()" style="margin-top: 20px;">Back to Home</button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <%- include('partials/footer') %>
    </div>

    <script src="/app.js"></script>
    <script>
        // Get search parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        const page = parseInt(urlParams.get('page')) || 1;

        // Initialize search when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for app to initialize
            if (window.app) {
                await window.app.checkAuthStatus();
            } else {
                setTimeout(async () => {
                    if (window.app) {
                        await window.app.checkAuthStatus();
                    }
                }, 500);
            }

            if (query) {
                performSearch(query, page);
            } else {
                showError('No search query provided');
            }
        });

        async function performSearch(searchQuery, pageNum = 1) {
            try {
                showLoading();
                console.log('Searching for:', searchQuery);

                const response = await fetch(`/api/games/search?q=${encodeURIComponent(searchQuery)}&page=${pageNum}&pageSize=20`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Search response:', data);

                if (data.success) {
                    displaySearchResults(data.games, data.totalResults, data.currentPage, data.totalPages, searchQuery);
                    if (data.isMockData) {
                        showMockDataNotice();
                    }
                } else {
                    showError(data.error || 'Failed to search games');
                }
            } catch (error) {
                console.error('Error searching games:', error);
                showError(`Network error: ${error.message}. Please try again.`);
            }
        }

        function showLoading() {
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchError').style.display = 'none';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchPagination').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('mockDataNotice').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('searchLoading').style.display = 'none';
            document.getElementById('searchError').style.display = 'block';
            document.getElementById('searchErrorMessage').textContent = message;
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchPagination').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('mockDataNotice').style.display = 'none';
        }

        function showMockDataNotice() {
            document.getElementById('mockDataNotice').style.display = 'block';
        }

        function displaySearchResults(games, totalResults, currentPage, totalPages, query) {
            document.getElementById('searchLoading').style.display = 'none';
            document.getElementById('searchError').style.display = 'none';
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('searchPagination').style.display = 'block';
            document.getElementById('noResults').style.display = 'none';

            // Update title
            document.getElementById('searchTitle').textContent = `Search Results for "${query}"`;
            document.getElementById('searchSubtitle').textContent = `${totalResults} games found`;

            // Display games
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            if (games.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchPagination').style.display = 'none';
                return;
            }

            games.forEach((game, index) => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card-simple';
                gameCard.onclick = () => viewGameDetails(game.id);
                gameCard.style.cursor = 'pointer';
                
                // Escape game name for HTML
                const escapedName = game.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                
                // Use backgroundImage or try alternative property names
                const imageUrl = game.backgroundImage || game.background_image || game.image || null;
                
                // Build rating HTML if available
                let ratingHTML = '';
                if (game.rating || game.metacritic) {
                    ratingHTML = '<div class="game-card-rating">';
                    if (game.rating) {
                        ratingHTML += `<span class="rating-badge"><i class="fas fa-star"></i> ${game.rating.toFixed(1)}</span>`;
                    }
                    if (game.metacritic) {
                        ratingHTML += `<span class="metacritic-badge">M: ${game.metacritic}</span>`;
                    }
                    ratingHTML += '</div>';
                }
                
                gameCard.innerHTML = `
                    <div class="game-image-simple">
                        ${imageUrl ? 
                            `<img src="${imageUrl}" alt="${escapedName}" class="game-image" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'no-image\\'><i class=\\'fas fa-gamepad\\'></i></div>'">` : 
                            '<div class="no-image"><i class="fas fa-gamepad"></i></div>'
                        }
                        ${ratingHTML}
                    </div>
                    <div class="game-name-simple">
                        <h3 class="game-title-simple">${escapedName}</h3>
                    </div>
                `;
                resultsContainer.appendChild(gameCard);
            });

            // Display pagination
            displayPagination(currentPage, totalPages, query);
        }

        function displayPagination(currentPage, totalPages, query) {
            const paginationContainer = document.getElementById('searchPagination');
            paginationContainer.innerHTML = '';

            if (totalPages <= 1) return;

            const pagination = document.createElement('div');
            pagination.className = 'pagination-large';

            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'btn btn-secondary';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Previous';
                prevBtn.onclick = () => window.location.href = `/search?q=${encodeURIComponent(query)}&page=${currentPage - 1}`;
                pagination.appendChild(prevBtn);
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => window.location.href = `/search?q=${encodeURIComponent(query)}&page=${i}`;
                pagination.appendChild(pageBtn);
            }

            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-secondary';
                nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
                nextBtn.onclick = () => window.location.href = `/search?q=${encodeURIComponent(query)}&page=${currentPage + 1}`;
                pagination.appendChild(nextBtn);
            }

            paginationContainer.appendChild(pagination);
        }

        function viewGameDetails(gameId) {
            // Use the app's game details function if available
            if (window.app && window.app.viewGameDetails) {
                window.app.viewGameDetails(gameId);
            } else {
                // Fallback: wait for app to initialize
                setTimeout(() => {
                    if (window.app && window.app.viewGameDetails) {
                        window.app.viewGameDetails(gameId);
                    } else {
                        if (window.app) {
                            window.app.showAlert('Game details feature is loading. Please try again in a moment.', 'Loading', 'info');
                        } else {
                            alert('Please wait for the page to load completely.');
                        }
                    }
                }, 500);
            }
        }

        async function addToWishlist(gameId, gameName) {
            // Check if user is logged in
            if (!window.app || !window.app.currentUser) {
                if (window.app) {
                    await window.app.showAlert('Please log in to add games to your wishlist', 'Login Required', 'warning');
                } else {
                    alert('Please log in to add games to your wishlist');
                }
                return;
            }

            // Get user's wishlists
            try {
                const response = await fetch(`/api/wishlists/${window.app.currentUser.username}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                const wishlists = data.success ? (data.wishlists || []) : [];

                if (wishlists.length === 0) {
                    // No wishlists, create default and add
                    if (window.app) {
                        await window.app.addToWishlist(gameId, gameName);
                    }
                } else if (wishlists.length === 1) {
                    // Only one wishlist, add directly
                    if (window.app) {
                        await window.app.addToWishlistWithId(gameId, gameName, wishlists[0].id);
                    }
                } else {
                    // Multiple wishlists, show selection modal
                    if (window.app && window.app.showWishlistSelectionModal) {
                        window.app.showWishlistSelectionModal(gameId, gameName, wishlists);
                    } else {
                        // Fallback: add to first wishlist
                        if (window.app) {
                            await window.app.addToWishlistWithId(gameId, gameName, wishlists[0].id);
                        }
                    }
                }
            } catch (error) {
                console.error('Error adding to wishlist:', error);
                if (window.app) {
                    window.app.showAlert('Error adding game to wishlist', 'Error', 'error');
                } else {
                    alert('Error adding game to wishlist');
                }
            }
        }

        function retrySearch() {
            if (query) {
                performSearch(query, page);
            }
        }

        function goBack() {
            window.location.href = '/';
        }

        // Generate star rating display (1-5 stars with half stars)
        function generateStarRating(rating) {
            if (!rating || rating <= 0) {
                return '<span class="no-rating">No rating</span>';
            }

            // Ensure rating is between 0 and 5
            const normalizedRating = Math.min(Math.max(rating, 0), 5);
            const fullStars = Math.floor(normalizedRating);
            const hasHalfStar = normalizedRating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let starsHTML = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fas fa-star star-full"></i>';
            }
            
            // Half star
            if (hasHalfStar) {
                starsHTML += '<i class="fas fa-star-half-alt star-half"></i>';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="far fa-star star-empty"></i>';
            }

            return starsHTML;
        }
    </script>
</body>
</html>
