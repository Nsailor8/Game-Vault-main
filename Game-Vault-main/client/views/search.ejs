<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - Game Vault</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <%- include('partials/header', { activePage: 'search', homeLink: '/' }) %>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Search Results Section -->
            <section class="section">
                <div class="section-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <h2 id="searchTitle">üîç Search Results</h2>
                            <p id="searchSubtitle">Loading search results...</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-secondary" onclick="showAdvancedSearch()" id="advancedSearchBtn">
                                <i class="fas fa-sliders-h"></i> Filters
                            </button>
                            <button class="btn btn-secondary" onclick="goBack()">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Search / Filters Panel -->
                <div id="advancedSearchPanel" class="advanced-search-panel" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9ff; border-radius: 15px; border: 1px solid rgba(102, 126, 234, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #667eea;">
                            <i class="fas fa-filter"></i> Search Filters
                        </h3>
                        <button class="btn btn-sm btn-secondary" onclick="closeAdvancedSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="filter-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <!-- Sort Options -->
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                <i class="fas fa-sort"></i> Sort By
                            </label>
                            <select id="sortBy" class="filter-select" onchange="applyFilters()">
                                <option value="rating">Highest Rated</option>
                                <option value="newest">Newest Release</option>
                                <option value="oldest">Oldest Release</option>
                                <option value="title">Title A-Z</option>
                                <option value="metacritic">Metacritic Score</option>
                            </select>
                        </div>

                        <!-- Platform Filter -->
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                <i class="fas fa-desktop"></i> Platform
                            </label>
                            <select id="platformFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Platforms</option>
                                <option value="Windows">Windows</option>
                                <option value="Mac">Mac</option>
                                <option value="Linux">Linux</option>
                                <option value="PlayStation">PlayStation</option>
                                <option value="Xbox">Xbox</option>
                                <option value="Nintendo">Nintendo</option>
                            </select>
                        </div>

                        <!-- Minimum Rating -->
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                <i class="fas fa-star"></i> Min Rating
                            </label>
                            <select id="minRating" class="filter-select" onchange="applyFilters()">
                                <option value="0">Any Rating</option>
                                <option value="1">1+ Stars</option>
                                <option value="2">2+ Stars</option>
                                <option value="3">3+ Stars</option>
                                <option value="4">4+ Stars</option>
                                <option value="5">5 Stars</option>
                            </select>
                        </div>

                        <!-- Minimum Metacritic -->
                        <div class="filter-group">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                <i class="fas fa-chart-line"></i> Min Metacritic
                            </label>
                            <select id="minMetacritic" class="filter-select" onchange="applyFilters()">
                                <option value="0">Any Score</option>
                                <option value="50">50+</option>
                                <option value="60">60+</option>
                                <option value="70">70+</option>
                                <option value="80">80+</option>
                                <option value="90">90+</option>
                            </select>
                        </div>
                    </div>

                    <!-- Active Filters -->
                    <div id="activeFilters" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Active filter tags will appear here -->
                    </div>

                    <!-- Clear Filters Button -->
                    <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
                        <button class="btn btn-sm btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-redo"></i> Clear All Filters
                        </button>
                    </div>
                </div>

                <!-- Search History -->
                <div id="searchHistoryContainer" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #667eea; margin: 0;">
                            <i class="fas fa-history"></i> Recent Searches
                        </h4>
                        <button class="btn btn-sm btn-secondary" onclick="clearSearchHistory()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    <div id="searchHistory" class="search-history-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Recent search items will appear here -->
                    </div>
                </div>

                <!-- Loading State -->
                <div id="searchLoading" class="search-loading" style="display: block;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Searching games...</p>
                </div>

                <!-- Error State -->
                <div id="searchError" class="search-error" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Search Error</h3>
                    <p id="searchErrorMessage"></p>
                    <button class="btn btn-primary" onclick="retrySearch()">Try Again</button>
                </div>

                <!-- Mock Data Notice -->
                <div id="mockDataNotice" class="mock-data-notice" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Loading:</strong> The Steam game database is being loaded. If you see sample data, the Steam app list is still loading (this may take a moment on first use).
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="games-grid" style="display: none;">
                    <!-- Game cards will be populated here -->
                </div>

                <!-- Pagination -->
                <div id="searchPagination" class="search-pagination" style="display: none; margin-top: 30px; text-align: center;">
                    <!-- Pagination will be populated here -->
                </div>

                <!-- No Results -->
                <div id="noResults" class="empty-state" style="display: none;">
                    <i class="fas fa-search"></i>
                    <h3>No Games Found</h3>
                    <p>Try a different search term</p>
                    <button class="btn btn-primary" onclick="goBack()" style="margin-top: 20px;">Back to Home</button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <%- include('partials/footer') %>
    </div>

    <script src="/app.js"></script>
    <script>
        // Get search parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        const page = parseInt(urlParams.get('page')) || 1;

        // Initialize search when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for app to initialize and check auth status
            // Don't reset user state if check fails - preserve existing session
            if (window.app) {
                try {
                    await window.app.checkAuthStatus();
                } catch (error) {
                    console.error('Auth check error (non-fatal):', error);
                    // Don't reset UI if check fails - user might still be logged in
                    // Only update UI if we successfully got a user
                }
            } else {
                setTimeout(async () => {
                    if (window.app) {
                        try {
                            await window.app.checkAuthStatus();
                        } catch (error) {
                            console.error('Auth check error (non-fatal):', error);
                            // Don't reset UI if check fails
                        }
                    }
                }, 500);
            }

            // Load search history
            loadSearchHistory();

            if (query) {
                // Add to search history
                addToSearchHistory(query);
                performSearch(query, page);
            } else {
                showError('No search query provided');
            }
        });

        async function performSearch(searchQuery, pageNum = 1) {
            try {
                showLoading();
                console.log('Searching for:', searchQuery);

                const response = await fetch(`/api/games/search?q=${encodeURIComponent(searchQuery)}&page=${pageNum}&pageSize=20`, {
                    credentials: 'include', // Important: include session cookies
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Search response:', data);

                if (data.success) {
                    displaySearchResults(data.games, data.totalResults, data.currentPage, data.totalPages, searchQuery);
                    if (data.isMockData) {
                        showMockDataNotice();
                    }
                } else {
                    showError(data.error || 'Failed to search games');
                }
            } catch (error) {
                console.error('Error searching games:', error);
                showError(`Network error: ${error.message}. Please try again.`);
            }
        }

        function showLoading() {
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchError').style.display = 'none';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchPagination').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('mockDataNotice').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('searchLoading').style.display = 'none';
            document.getElementById('searchError').style.display = 'block';
            document.getElementById('searchErrorMessage').textContent = message;
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchPagination').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('mockDataNotice').style.display = 'none';
        }

        function showMockDataNotice() {
            document.getElementById('mockDataNotice').style.display = 'block';
        }

        function displaySearchResults(games, totalResults, currentPage, totalPages, query) {
            document.getElementById('searchLoading').style.display = 'none';
            document.getElementById('searchError').style.display = 'none';
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('searchPagination').style.display = 'block';
            document.getElementById('noResults').style.display = 'none';

            // Update title
            document.getElementById('searchTitle').textContent = `Search Results for "${query}"`;
            document.getElementById('searchSubtitle').textContent = `${totalResults} games found`;

            // Display games
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            if (games.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchPagination').style.display = 'none';
                return;
            }

            games.forEach((game, index) => {
                const gameCard = createGameCard(game);
                resultsContainer.appendChild(gameCard);
            });

            // Display pagination
            displayPagination(currentPage, totalPages, query);
        }

        function displayPagination(currentPage, totalPages, query) {
            const paginationContainer = document.getElementById('searchPagination');
            paginationContainer.innerHTML = '';

            if (totalPages <= 1) return;

            const pagination = document.createElement('div');
            pagination.className = 'pagination-large';

            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'btn btn-secondary';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Previous';
                prevBtn.onclick = () => window.location.href = `/search?q=${encodeURIComponent(query)}&page=${currentPage - 1}`;
                pagination.appendChild(prevBtn);
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => window.location.href = `/search?q=${encodeURIComponent(query)}&page=${i}`;
                pagination.appendChild(pageBtn);
            }

            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-secondary';
                nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
                nextBtn.onclick = () => window.location.href = `/search?q=${encodeURIComponent(query)}&page=${currentPage + 1}`;
                pagination.appendChild(nextBtn);
            }

            paginationContainer.appendChild(pagination);
        }

        function viewGameDetails(gameId) {
            // Use the app's game details function if available
            if (window.app && window.app.viewGameDetails) {
                window.app.viewGameDetails(gameId);
            } else {
                // Fallback: wait for app to initialize
                setTimeout(() => {
                    if (window.app && window.app.viewGameDetails) {
                        window.app.viewGameDetails(gameId);
                    } else {
                        if (window.app) {
                            window.app.showAlert('Game details feature is loading. Please try again in a moment.', 'Loading', 'info');
                        } else {
                            alert('Please wait for the page to load completely.');
                        }
                    }
                }, 500);
            }
        }

        async function addToLibrary(gameId, gameName) {
            // Check if user is logged in
            if (!window.app || !window.app.currentUser) {
                if (window.app) {
                    await window.app.showAlert('Please log in to add games to your library', 'Login Required', 'warning');
                } else {
                    alert('Please log in to add games to your library');
                }
                return;
            }

            // Get user's libraries
            try {
                const response = await fetch(`/api/wishlists/${window.app.currentUser.username}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                const libraries = data.success ? (data.wishlists || []) : [];

                if (libraries.length === 0) {
                    // No libraries, create default and add
                    if (window.app) {
                        await window.app.addToLibrary(gameId, gameName);
                    }
                } else if (libraries.length === 1) {
                    // Only one library, add directly
                    if (window.app) {
                        await window.app.addToLibraryWithId(gameId, gameName, libraries[0].id);
                    }
                } else {
                    // Multiple libraries, show selection modal
                    if (window.app && window.app.showLibrarySelectionModal) {
                        window.app.showLibrarySelectionModal(gameId, gameName, libraries);
                    } else {
                        // Fallback: show simple selection
                        showLibrarySelection(gameId, gameName, libraries);
                    }
                }
            } catch (error) {
                console.error('Error adding to library:', error);
                if (window.app) {
                    window.app.showAlert('Error adding game to library', 'Error', 'error');
                } else {
                    alert('Error adding game to library');
                }
            }
        }

        function showLibrarySelection(gameId, gameName, libraries) {
            const libraryNames = libraries.map(lib => lib.name).join('\n');
            const libraryIds = libraries.map(lib => lib.id);
            const selectedIndex = prompt(`Select a library to add "${gameName}" to:\n\n${libraries.map((lib, i) => `${i + 1}. ${lib.name} (${lib.gameCount || 0} games)`).join('\n')}\n\nEnter number (1-${libraries.length}):`);
            
            if (selectedIndex && !isNaN(selectedIndex) && selectedIndex >= 1 && selectedIndex <= libraries.length) {
                const selectedLibrary = libraries[parseInt(selectedIndex) - 1];
                if (window.app && window.app.addToLibraryWithId) {
                    window.app.addToLibraryWithId(gameId, gameName, selectedLibrary.id);
                }
            }
        }

        // Backward compatibility
        async function addToWishlist(gameId, gameName) {
            return await addToLibrary(gameId, gameName);
        }

        function retrySearch() {
            if (query) {
                performSearch(query, page);
            }
        }

        function goBack() {
            window.location.href = '/';
        }

        // === FILTER FUNCTIONS ===
        
        function showAdvancedSearch() {
            const panel = document.getElementById('advancedSearchPanel');
            panel.style.display = 'block';
        }

        function closeAdvancedSearch() {
            const panel = document.getElementById('advancedSearchPanel');
            panel.style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('sortBy').value = 'rating';
            document.getElementById('platformFilter').value = '';
            document.getElementById('minRating').value = '0';
            document.getElementById('minMetacritic').value = '0';
            applyFilters();
        }

        function applyFilters() {
            // Get all filter values
            const sortBy = document.getElementById('sortBy').value;
            const platform = document.getElementById('platformFilter').value;
            const minRating = parseFloat(document.getElementById('minRating').value);
            const minMetacritic = parseInt(document.getElementById('minMetacritic').value);

            // Get all game cards
            const gamesContainer = document.getElementById('searchResults');
            const gameCards = gamesContainer.querySelectorAll('.game-card-simple');
            
            if (gameCards.length === 0) return;

            // Store game data for filtering
            const gamesData = Array.from(gameCards).map(card => {
                const gameInfo = card.getAttribute('data-game-info');
                return gameInfo ? JSON.parse(gameInfo) : null;
            }).filter(g => g !== null);

            // Filter games
            let filteredGames = gamesData.filter(game => {
                // Platform filter
                if (platform) {
                    const gamePlatforms = game.platforms || [];
                    const hasPlatform = gamePlatforms.some(p => 
                        p.name && p.name.toLowerCase().includes(platform.toLowerCase())
                    );
                    if (!hasPlatform) return false;
                }

                // Rating filter
                if (minRating > 0 && (!game.rating || game.rating < minRating)) {
                    return false;
                }

                // Metacritic filter
                if (minMetacritic > 0 && (!game.metacritic || game.metacritic < minMetacritic)) {
                    return false;
                }

                return true;
            });

            // Sort games
            filteredGames.sort((a, b) => {
                switch (sortBy) {
                    case 'title':
                        return a.name.localeCompare(b.name);
                    
                    case 'newest':
                        const dateA = new Date(a.released || '1900-01-01');
                        const dateB = new Date(b.released || '1900-01-01');
                        return dateB - dateA;
                    
                    case 'oldest':
                        const dateAOld = new Date(a.released || '9999-12-31');
                        const dateBOld = new Date(b.released || '9999-12-31');
                        return dateAOld - dateBOld;
                    
                    case 'metacritic':
                        return (b.metacritic || 0) - (a.metacritic || 0);
                    
                    case 'rating':
                    default:
                        const scoreA = (a.metacritic || 0) * 10 + (a.rating || 0) * 2;
                        const scoreB = (b.metacritic || 0) * 10 + (b.rating || 0) * 2;
                        return scoreB - scoreA;
                }
            });

            // Update active filters display
            updateActiveFilters(sortBy, platform, minRating, minMetacritic);

            // Re-render filtered games
            gamesContainer.innerHTML = '';
            if (filteredGames.length === 0) {
                gamesContainer.parentElement.innerHTML += `
                    <div class="empty-state" style="display: block;">
                        <i class="fas fa-filter"></i>
                        <h3>No Games Match Filters</h3>
                        <p>Try adjusting your filter criteria</p>
                        <button class="btn btn-primary" onclick="clearFilters()" style="margin-top: 20px;">
                            Clear Filters
                        </button>
                    </div>
                `;
            } else {
                filteredGames.forEach(game => {
                    const gameCard = createGameCard(game);
                    gamesContainer.appendChild(gameCard);
                });
            }
        }

        function updateActiveFilters(sortBy, platform, minRating, minMetacritic) {
            const activeFiltersContainer = document.getElementById('activeFilters');
            let html = '';

            if (sortBy !== 'rating') {
                html += `<span class="filter-tag"><i class="fas fa-sort"></i> ${getSortLabel(sortBy)} <i class="fas fa-times" onclick="removeFilter('sort')"></i></span>`;
            }

            if (platform) {
                html += `<span class="filter-tag"><i class="fas fa-desktop"></i> ${platform} <i class="fas fa-times" onclick="removeFilter('platform')"></i></span>`;
            }

            if (minRating > 0) {
                html += `<span class="filter-tag"><i class="fas fa-star"></i> ${minRating}+ Rating <i class="fas fa-times" onclick="removeFilter('rating')"></i></span>`;
            }

            if (minMetacritic > 0) {
                html += `<span class="filter-tag"><i class="fas fa-chart-line"></i> MC ${minMetacritic}+ <i class="fas fa-times" onclick="removeFilter('metacritic')"></i></span>`;
            }

            activeFiltersContainer.innerHTML = html;
        }

        function getSortLabel(sortBy) {
            const labels = {
                'title': 'Title',
                'newest': 'Newest',
                'oldest': 'Oldest',
                'metacritic': 'Metacritic',
                'rating': 'Highest Rated'
            };
            return labels[sortBy] || sortBy;
        }

        function removeFilter(filterType) {
            switch (filterType) {
                case 'sort':
                    document.getElementById('sortBy').value = 'rating';
                    break;
                case 'platform':
                    document.getElementById('platformFilter').value = '';
                    break;
                case 'rating':
                    document.getElementById('minRating').value = '0';
                    break;
                case 'metacritic':
                    document.getElementById('minMetacritic').value = '0';
                    break;
            }
            applyFilters();
        }

        function createGameCard(game) {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card-simple';
            gameCard.onclick = () => viewGameDetails(game.id);
            gameCard.style.cursor = 'pointer';
            gameCard.setAttribute('data-game-info', JSON.stringify(game));
            
            const escapedName = game.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const imageUrl = game.backgroundImage || game.background_image || game.image || null;
            
            let ratingHTML = '';
            if (game.rating || game.metacritic) {
                ratingHTML = '<div class="game-card-rating">';
                if (game.rating) {
                    ratingHTML += `<span class="rating-badge"><i class="fas fa-star"></i> ${game.rating.toFixed(1)}</span>`;
                }
                if (game.metacritic) {
                    ratingHTML += `<span class="metacritic-badge">M: ${game.metacritic}</span>`;
                }
                ratingHTML += '</div>';
            }
            
            gameCard.innerHTML = `
                <div class="game-image-simple">
                    ${imageUrl ? 
                        `<img src="${imageUrl}" alt="${escapedName}" class="game-image" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'no-image\\'><i class=\\'fas fa-gamepad\\'></i></div>'">` : 
                        '<div class="no-image"><i class="fas fa-gamepad"></i></div>'
                    }
                    ${ratingHTML}
                </div>
                <div class="game-name-simple">
                    <h3 class="game-title-simple">${escapedName}</h3>
                </div>
            `;
            
            return gameCard;
        }

        // === SEARCH HISTORY FUNCTIONS ===

        function addToSearchHistory(query) {
            if (!query || query.trim() === '') return;
            
            let history = JSON.parse(localStorage.getItem('gameVaultSearchHistory') || '[]');
            
            // Remove if already exists
            history = history.filter(item => item.toLowerCase() !== query.toLowerCase());
            
            // Add to front
            history.unshift(query);
            
            // Keep only last 10
            history = history.slice(0, 10);
            
            // Save
            localStorage.setItem('gameVaultSearchHistory', JSON.stringify(history));
            
            // Update display
            loadSearchHistory();
        }

        function loadSearchHistory() {
            const history = JSON.parse(localStorage.getItem('gameVaultSearchHistory') || '[]');
            const container = document.getElementById('searchHistory');
            const historyContainer = document.getElementById('searchHistoryContainer');
            
            if (history.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }
            
            historyContainer.style.display = 'block';
            container.innerHTML = history.map(item => `
                <button class="history-item btn btn-sm btn-secondary" onclick="searchHistoryItem('${item.replace(/'/g, "\\'")}')">
                    <i class="fas fa-history"></i> ${item}
                </button>
            `).join('');
        }

        function clearSearchHistory() {
            localStorage.removeItem('gameVaultSearchHistory');
            document.getElementById('searchHistoryContainer').style.display = 'none';
        }

        function searchHistoryItem(query) {
            window.location.href = `/search?q=${encodeURIComponent(query)}`;
        }

        // Generate star rating display (1-5 stars with half stars)
        function generateStarRating(rating) {
            if (!rating || rating <= 0) {
                return '<span class="no-rating">No rating</span>';
            }

            // Ensure rating is between 0 and 5
            const normalizedRating = Math.min(Math.max(rating, 0), 5);
            const fullStars = Math.floor(normalizedRating);
            const hasHalfStar = normalizedRating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let starsHTML = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fas fa-star star-full"></i>';
            }
            
            // Half star
            if (hasHalfStar) {
                starsHTML += '<i class="fas fa-star-half-alt star-half"></i>';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="far fa-star star-empty"></i>';
            }

            return starsHTML;
        }
    </script>
</body>
</html>
