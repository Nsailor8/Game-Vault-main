<!DOCTYPE html>
<html lang="en">
    <%- include('partials/head', { pageTitle: 'Profile' }) %>
<body>
    <%- include('partials/header') %>
  <div class="container">
    
    <main id="mainContent" class="main-content">
      
      <section id="profileSection" class="content-section active">
        <div class="profile-header">
          <div class="profile-avatar">
            <% if (profile.avatar_path) { %>
              <img src="<%= profile.avatar_path %>" alt="Profile Avatar" id="profileAvatarImg" class="avatar-image">
            <% } else { %>
              <img src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(profile.username) %>&size=120&background=667eea&color=fff&bold=true" alt="Profile Avatar" id="profileAvatarImg" class="avatar-image">
            <% } %>
            <% if (profile.isCurrentUser) { %>
              <div class="avatar-upload-overlay">
                <label for="avatarUpload" class="avatar-upload-btn" title="Change avatar">
                  <i class="fas fa-camera"></i>
                </label>
                <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
              </div>
            <% } %>
          </div>
          <div class="profile-info">
            <h2 id="profileUsername"><%= profile.username || 'Loading...' %></h2>
            <p id="profileEmail"><%= profile.email || 'Loading...' %></p>
            <p id="profileJoinDate">Joined: <%= profile.joinDate ? new Date(profile.joinDate).toLocaleDateString('en-US', { year: 'numeric', month: 'numeric', day: 'numeric' }) : 'Loading...' %></p>
          </div>
          <div class="profile-actions">
            <button id="editProfileBtn" class="btn btn-secondary">Edit Profile</button>
          </div>
        </div>

        <div class="profile-stats" 
             data-total-games="<%= profile.totalGames || 0 %>"
             data-total-playtime="<%= profile.totalPlaytime || 0 %>"
             data-avg-rating="<%= profile.avgRating || 0 %>">
          <div class="stat-card">
            <i class="fas fa-gamepad"></i>
            <h3 id="totalGames"><%= profile.totalGames || 0 %></h3>
            <p>Games Played</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-clock"></i>
            <h3 id="totalPlaytime"><%= profile.totalPlaytime || 0 %></h3>
            <p>Hours Played</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-star"></i>
            <h3 id="avgRating"><%= profile.avgRating || 0 %></h3>
            <p>Avg Rating</p>
          </div>
        </div>


        
        <% if (profile.steamLinked) { %>
        <div id="steamProfileSection" class="steam-profile-section">
          <h3>Steam Profile</h3>
          <div class="steam-profile-info">
            <div class="steam-avatar">
              <% if (profile.steam_profile && profile.steam_profile.avatarfull) { %>
                <img id="steamAvatar" src="<%= profile.steam_profile.avatarfull %>" alt="Steam Avatar">
              <% } else { %>
                <img id="steamAvatar" src="" alt="Steam Avatar">
              <% } %>
            </div>
            <div class="steam-details">
              <h4 id="steamUsername"><%= profile.steam_profile ? profile.steam_profile.personaname : 'Steam User' %></h4>
              <% if (profile.steam_profile && profile.steam_profile.profileurl) { %>
                <p id="steamProfileUrl"><a href="<%= profile.steam_profile.profileurl %>" target="_blank">View Steam Profile</a></p>
              <% } else { %>
                <p id="steamProfileUrl">Profile URL</p>
              <% } %>
              <% if (profile.isCurrentUser) { %>
              <div class="steam-actions">
                <button id="syncSteamGamesBtn" class="btn btn-primary">
                  <i class="fas fa-sync-alt"></i> Sync Steam Games
                </button>
                <button id="importSteamLibraryBtn" class="btn btn-secondary" style="display: none;">Import Steam Library</button>
                <button id="disconnectSteamBtn" class="btn btn-danger">Disconnect Steam</button>
              </div>
              <% } %>
            </div>
          </div>
        </div>
        <% } else { %>
        
        <div id="steamConnectSection" class="steam-connect-section">
          <h3>Connect Your Steam Account</h3>
          <p>Link your Steam account to import your game library and achievements</p>
          <button id="connectSteamBtn" class="btn steam-connect-btn">
            <i class="fab fa-steam"></i> Connect Steam
          </button>
        </div>
        <% } %>
        
        
        <div class="profile-details">
          <h3>Profile Information</h3>
          <div class="detail-item">
            <div class="detail-label">Bio</div>
            <div class="detail-value" id="profileBio"><%= profile.bio || 'No bio set' %></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Play Style</div>
            <div class="detail-value" id="playStyleDisplay"><%= profile.playStyle || 'Not specified' %></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Favorite Genres</div>
            <div class="detail-value" id="favoriteGenresDisplay"><%= profile.favoriteGenres && profile.favoriteGenres.length > 0 ? profile.favoriteGenres.join(', ') : 'None set' %></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Preferred Platforms</div>
            <div class="detail-value" id="preferredPlatformsDisplay"><%= profile.preferredPlatforms && profile.preferredPlatforms.length > 0 ? profile.preferredPlatforms.join(', ') : 'None set' %></div>
          </div>
        </div>

        
        <% if (profile.steamLinked && profile.steam_games && profile.steam_games.length > 0) { %>
        <div id="steamGamesSection" class="steam-games-section">
          <div class="steam-games-header">
            <h3>Steam Games Library (<span id="gamesCount"><%= profile.steam_games.length %></span> games)</h3>
            <div class="steam-games-controls">
              <select id="gamesSortSelect" class="sort-select">
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="playtime-desc">Most Played</option>
                <option value="playtime-asc">Least Played</option>
              </select>
              <button id="toggleGamesList" class="btn btn-secondary collapse-btn">
                <i class="fas fa-chevron-up"></i> Collapse
              </button>
            </div>
          </div>
          <div id="gamesListContainer" class="games-list-container">
            <div class="steam-games-grid" id="steamGamesGrid">
              <% profile.steam_games.forEach(function(game) { %>
              <div class="steam-game-card" data-appid="<%= game.appid %>" data-name="<%= game.name.toLowerCase() %>" data-playtime="<%= game.playtime_forever || 0 %>" data-achievements="<%= game.achievements || 0 %>">
                <a href="https://store.steampowered.com/app/<%= game.appid %>" target="_blank" class="steam-game-link">
                  <div class="steam-game-image-container">
                    <img class="steam-game-image" 
                         src="https://cdn.akamai.steamstatic.com/steam/apps/<%= game.appid %>/library_600x900.jpg" 
                         alt="<%= game.name %>"
                         onerror="this.src='https://cdn.akamai.steamstatic.com/steam/apps/<%= game.appid %>/header.jpg'; this.onerror=function(){this.src='https://via.placeholder.com/300x400?text=<%= encodeURIComponent(game.name) %>';};"
                         loading="lazy">
                    <div class="steam-game-badges">
                      <% if (game.rating && game.rating > 0) { %>
                      <div class="steam-rating-badge">
                        <i class="fas fa-star"></i>
                        <span><%= game.rating.toFixed(1) %></span>
                      </div>
                      <% } %>
                      <% if (game.metacritic) { %>
                      <div class="steam-metacritic-badge">
                        <span>M: <%= game.metacritic %></span>
                      </div>
                      <% } %>
                    </div>
                  </div>
                  <div class="steam-game-title">
                    <%= game.name %>
                  </div>
                  <div class="game-playtime" style="display: none;">
                    <i class="fas fa-clock"></i>
                    <span class="playtime-hours"><%= Math.round((game.playtime_forever || 0) / 60) %></span> hours
                  </div>
                </a>
              </div>
              <% }); %>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Achievements Section -->
        <% if (profile.steamLinked && profile.steam_games && profile.steam_games.length > 0) { %>
          <% 
            // Collect all achievements from games
            let allAchievements = [];
            let totalAchievements = 0;
            let unlockedAchievements = 0;
            
            profile.steam_games.forEach(function(game) {
              if (game.achievements && Array.isArray(game.achievements)) {
                game.achievements.forEach(function(achievement) {
                  if (achievement.achieved) {
                    allAchievements.push({
                      ...achievement,
                      gameName: game.name,
                      gameAppid: game.appid
                    });
                    unlockedAchievements++;
                  }
                  totalAchievements++;
                });
              } else if (game.unlockedAchievements !== undefined && game.achievementCount !== undefined) {
                // If we have counts but not full achievement data
                unlockedAchievements += game.unlockedAchievements || 0;
                totalAchievements += game.achievementCount || 0;
              }
            });
            
            // Sort by unlock time (most recent first)
            allAchievements.sort((a, b) => {
              const timeA = a.unlocktime ? new Date(a.unlocktime * 1000) : new Date(0);
              const timeB = b.unlocktime ? new Date(b.unlocktime * 1000) : new Date(0);
              return timeB - timeA;
            });
          %>
          
          <% if (allAchievements.length > 0 || unlockedAchievements > 0) { %>
          <div id="achievementsSection" class="achievements-section">
            <div class="achievements-header">
              <h3>
                <i class="fas fa-trophy"></i> Achievements
                <span class="achievement-stats">
                  (<span id="unlockedCount"><%= unlockedAchievements %></span> / <span id="totalCount"><%= totalAchievements %></span> unlocked)
                </span>
              </h3>
              <div class="achievements-controls">
                <button id="toggleAchievementsList" class="btn btn-secondary collapse-btn">
                  <i class="fas fa-chevron-up"></i> Collapse
                </button>
              </div>
            </div>
            <div id="achievementsListContainer" class="achievements-list-container">
              <% if (allAchievements.length > 0) { %>
                <div class="achievements-grid" id="achievementsGrid">
                  <% allAchievements.slice(0, 50).forEach(function(achievement) { %>
                  <div class="achievement-card" data-game="<%= achievement.gameName %>">
                    <div class="achievement-icon">
                      <% if (achievement.icon) { %>
                        <img src="<%= achievement.icon %>" alt="<%= achievement.apiname || achievement.name %>" onerror="this.src='https://via.placeholder.com/64?text=ðŸ†';">
                      <% } else { %>
                        <div class="achievement-icon-placeholder">
                          <i class="fas fa-trophy"></i>
                        </div>
                      <% } %>
                    </div>
                    <div class="achievement-info">
                      <h4 class="achievement-name"><%= achievement.name || achievement.apiname || 'Unknown Achievement' %></h4>
                      <p class="achievement-game"><%= achievement.gameName %></p>
                      <% if (achievement.description) { %>
                        <p class="achievement-description"><%= achievement.description %></p>
                      <% } %>
                      <% if (achievement.unlocktime) { %>
                        <p class="achievement-date">
                          <i class="fas fa-calendar"></i> 
                          <%= new Date(achievement.unlocktime * 1000).toLocaleDateString() %>
                        </p>
                      <% } %>
                    </div>
                  </div>
                  <% }); %>
                </div>
                <% if (allAchievements.length > 50) { %>
                  <p class="achievements-more">Showing 50 of <%= allAchievements.length %> achievements. <a href="https://steamcommunity.com/profiles/<%= profile.steam_id %>" target="_blank">View all on Steam</a></p>
                <% } %>
              <% } else { %>
                <div class="achievements-summary">
                  <p><%= unlockedAchievements %> achievements unlocked across <%= profile.steam_games.length %> games</p>
                  <p><a href="https://steamcommunity.com/profiles/<%= profile.steam_id %>" target="_blank" class="btn btn-secondary">View Achievements on Steam</a></p>
                </div>
              <% } %>
            </div>
          </div>
          <% } %>
        <% } %>
      </section>
    </main>
  </div>
    <%- include('partials/loginModal') %>
    
    
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group">
                        <label for="editAvatar">Profile Picture</label>
                        <div class="avatar-upload-section">
                            <div class="avatar-preview-container">
                                <img id="avatarPreview" src="" alt="Avatar Preview" class="avatar-preview-image">
                                <div class="avatar-preview-placeholder" id="avatarPreviewPlaceholder">
                                    <i class="fas fa-user"></i>
                                    <span>No image selected</span>
                                </div>
                            </div>
                            <div class="avatar-upload-controls">
                                <label for="editAvatarInput" class="btn btn-secondary" style="cursor: pointer; display: inline-block;">
                                    <i class="fas fa-camera"></i> Choose Image
                                </label>
                                <input type="file" id="editAvatarInput" name="avatar" accept="image/*" style="display: none;">
                                <button type="button" id="removeAvatarBtn" class="btn btn-danger" style="display: none;">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                            <p class="avatar-upload-hint">Maximum file size: 5MB. Supported formats: JPG, PNG, GIF</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editBio">Bio</label>
                        <textarea id="editBio" name="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editPlayStyle">Play Style</label>
                        <select id="editPlayStyle" name="playStyle">
                            <option value="casual">Casual</option>
                            <option value="hardcore">Hardcore</option>
                            <option value="competitive">Competitive</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editFavoriteGenres">Favorite Genres</label>
                        <input type="text" id="editFavoriteGenres" name="favoriteGenres" placeholder="Action, RPG, Strategy (comma separated)">
                    </div>
                    
                    <div class="form-group">
                        <label for="editPreferredPlatforms">Preferred Platforms</label>
                        <input type="text" id="editPreferredPlatforms" name="preferredPlatforms" placeholder="PC, PlayStation, Xbox (comma separated)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal(document.getElementById('editProfileModal'))">Cancel</button>
                <button type="button" id="saveProfileBtn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    
  <script src="/app.js"></script>
  <script src="/profile.js"></script>
  <script>
    // If we're on /profile (without username) and have a logged-in user, redirect to username-specific route
    (function() {
      const pathParts = window.location.pathname.split('/').filter(p => p);
      if (pathParts.length === 1 && pathParts[0] === 'profile') {
        // We're on /profile - check if we have a user
        setTimeout(() => {
          if (window.app && window.app.currentUser && window.app.currentUser.username && !window.app.currentUser.isGuest) {
            console.log('[Profile] Redirecting to username-specific profile:', window.app.currentUser.username);
            window.location.href = `/profile/${window.app.currentUser.username}`;
            return;
          }
          // Check auth status and redirect if logged in
          fetch('/api/auth/check', {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.user && data.user.username) {
              console.log('[Profile] Auth check found user, redirecting to:', data.user.username);
              window.location.href = `/profile/${data.user.username}`;
            }
          })
          .catch(error => {
            console.error('[Profile] Error checking auth:', error);
          });
        }, 100);
      }
    })();
  </script>
  <script>

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Profile page - DOM Content Loaded');
      
      // Preserve statistics values from data attributes to prevent reset
      const statsContainer = document.querySelector('.profile-stats');
      if (statsContainer) {
        const totalGamesEl = document.getElementById('totalGames');
        const totalPlaytimeEl = document.getElementById('totalPlaytime');
        const avgRatingEl = document.getElementById('avgRating');
        
        // Store initial values from data attributes
        const initialGames = statsContainer.dataset.totalGames || '0';
        const initialPlaytime = statsContainer.dataset.totalPlaytime || '0';
        const initialRating = statsContainer.dataset.avgRating || '0';
        
        // Ensure values are set and prevent them from being reset to 0
        if (totalGamesEl && initialGames !== '0') {
          totalGamesEl.textContent = initialGames;
        }
        if (totalPlaytimeEl && initialPlaytime !== '0') {
          totalPlaytimeEl.textContent = initialPlaytime;
        }
        if (avgRatingEl && initialRating !== '0') {
          avgRatingEl.textContent = initialRating;
        }
        
        // Monitor for changes and restore if reset to 0
        const observer = new MutationObserver(() => {
          if (totalGamesEl && totalGamesEl.textContent === '0' && initialGames !== '0') {
            totalGamesEl.textContent = initialGames;
          }
          if (totalPlaytimeEl && totalPlaytimeEl.textContent === '0' && initialPlaytime !== '0') {
            totalPlaytimeEl.textContent = initialPlaytime;
          }
          if (avgRatingEl && avgRatingEl.textContent === '0' && initialRating !== '0') {
            avgRatingEl.textContent = initialRating;
          }
        });
        
        if (totalGamesEl) observer.observe(totalGamesEl, { childList: true, characterData: true });
        if (totalPlaytimeEl) observer.observe(totalPlaytimeEl, { childList: true, characterData: true });
        if (avgRatingEl) observer.observe(avgRatingEl, { childList: true, characterData: true });
      }
      
      // Check for Steam auth success parameter and reload page to show updated profile
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('steam_auth') === 'success') {
        console.log('Steam authentication successful, reloading page to show updated profile...');
        // Remove the parameter from URL and reload
        urlParams.delete('steam_auth');
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
        // Increase delay to ensure server has fully processed the session and database updates
        // Steam sync can take time, so we wait longer for database to be ready
        setTimeout(() => {
          window.location.reload();
        }, 2000); // Increased to 2000ms to allow database operations to complete
        return;
      }
      
      // Check for Steam auth error
      if (urlParams.get('error') === 'steam_auth_failed') {
        const reason = urlParams.get('reason') || 'unknown';
        const details = urlParams.get('details') || '';
        const message = urlParams.get('message') || '';
        
        console.error('Steam authentication failed:', { reason, details, message });
        
        let errorMessage = 'Failed to connect Steam account.';
        
        // Provide specific error messages based on reason
        switch(reason) {
          case 'no_user_data':
            errorMessage = 'Steam authentication failed: No user data received from Steam. Please try again.';
            break;
          case 'user_not_found':
            errorMessage = 'Failed to connect Steam account: Your account was not found. Please log out and log back in, then try again.';
            break;
          case 'db_user_not_found':
            errorMessage = 'Failed to connect Steam account: Database error. Please try again.';
            break;
          case 'link_failed':
            errorMessage = `Failed to connect Steam account: ${details || 'Linking failed. Please try again.'}`;
            break;
          case 'link_exception':
            errorMessage = `Failed to connect Steam account: ${details || 'An error occurred. Please try again.'}`;
            break;
          case 'database_error':
            errorMessage = `Failed to connect Steam account: Database error. ${details || 'Please try again.'}`;
            break;
          case 'reload_failed':
            errorMessage = 'Steam account connected, but there was an issue loading your profile. Please refresh the page.';
            break;
          case 'profile_creation_failed':
            errorMessage = 'Failed to create Steam profile. Please try again.';
            break;
          case 'exception':
            errorMessage = `Failed to connect Steam account: ${message || details || 'An unexpected error occurred. Please try again.'}`;
            break;
          default:
            errorMessage = `Failed to connect Steam account: ${details || message || 'Please try again.'}`;
        }
        
        alert(errorMessage);
        
        // Remove the error parameters from URL
        urlParams.delete('error');
        urlParams.delete('reason');
        urlParams.delete('details');
        urlParams.delete('message');
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
      }
      
      // Check for Steam auth success with warning
      if (urlParams.get('steam_auth') === 'success' && urlParams.get('warning') === 'reload_failed') {
        alert('Steam account connected successfully! However, there was an issue loading your full profile. The page will refresh to show your updated profile.');
      }
      
      // Set up Steam button event listeners
      const connectSteamBtn = document.getElementById('connectSteamBtn');
      if (connectSteamBtn) {
        connectSteamBtn.addEventListener('click', async () => {
          try {
            // Get username from multiple sources (URL path, page element, or session)
            let username = null;
            
            // Try to get from URL path first (e.g., /profile/nsailor8)
            const pathMatch = window.location.pathname.match(/\/profile\/([^\/]+)/);
            if (pathMatch) {
              username = pathMatch[1];
            }
            
            // Fallback to page element
            if (!username) {
              const usernameEl = document.getElementById('profileUsername');
              if (usernameEl) {
                username = usernameEl.textContent?.trim();
              }
            }
            
            // Fallback: try to get from session via API
            if (!username) {
              try {
                const sessionResponse = await fetch('/api/auth/status', {
                  credentials: 'include'
                });
                if (sessionResponse.ok) {
                  const sessionData = await sessionResponse.json();
                  if (sessionData.user && sessionData.user.username) {
                    username = sessionData.user.username;
                  }
                }
              } catch (e) {
                console.error('Error getting session:', e);
              }
            }
            
            if (!username) {
              alert('Unable to find username. Please refresh the page and try again.');
              return;
            }
            
            console.log('Connecting Steam for username:', username);
            
            // Call the Steam link endpoint to set up session
            const response = await fetch(`/api/auth/steam/link/${encodeURIComponent(username)}`, {
              method: 'POST',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                returnUrl: window.location.pathname
              })
            });
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({ error: 'Failed to connect Steam account' }));
              alert(errorData.error || `Error: ${response.status} ${response.statusText}`);
              return;
            }
            
            const data = await response.json();
            
            if (data.success && data.redirectUrl) {
              console.log('Redirecting to Steam OAuth:', data.redirectUrl);
              // Redirect to Steam OAuth
              window.location.href = data.redirectUrl;
            } else {
              alert(data.error || 'Failed to initiate Steam connection');
            }
          } catch (error) {
            console.error('Error connecting Steam account:', error);
            alert('Failed to connect Steam account. Please try again.');
          }
        });
      }
      
      // Sync Steam Games button
      const syncSteamGamesBtn = document.getElementById('syncSteamGamesBtn');
      if (syncSteamGamesBtn) {
        syncSteamGamesBtn.addEventListener('click', async () => {
          // Disable button and show loading state
          syncSteamGamesBtn.disabled = true;
          const originalText = syncSteamGamesBtn.innerHTML;
          syncSteamGamesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
          
          try {
            const response = await fetch('/api/steam/sync', {
              method: 'POST',
              credentials: 'include'
            });
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({ error: 'Failed to sync Steam games' }));
              alert(errorData.error || `Error: ${response.status} ${response.statusText}`);
              syncSteamGamesBtn.disabled = false;
              syncSteamGamesBtn.innerHTML = originalText;
              return;
            }
            
            const data = await response.json();
            if (data.success) {
              alert(`Successfully synced ${data.gamesCount || 0} games from Steam!`);
              // Reload page to show updated games
              window.location.reload();
            } else {
              alert(data.error || 'Failed to sync Steam games');
              syncSteamGamesBtn.disabled = false;
              syncSteamGamesBtn.innerHTML = originalText;
            }
          } catch (error) {
            console.error('Error syncing Steam games:', error);
            alert('Failed to sync Steam games. Please try again.');
            syncSteamGamesBtn.disabled = false;
            syncSteamGamesBtn.innerHTML = originalText;
          }
        });
      }
      
      // Keep importSteamLibraryBtn for backwards compatibility (hidden)
      const importSteamLibraryBtn = document.getElementById('importSteamLibraryBtn');
      if (importSteamLibraryBtn) {
        importSteamLibraryBtn.addEventListener('click', async () => {
          try {
            const response = await fetch('/api/steam/sync', {
              method: 'POST',
              credentials: 'include'
            });
            const data = await response.json();
            if (data.success) {
              alert('Steam library imported successfully!');
              window.location.reload();
            } else {
              alert(data.error || 'Failed to import Steam library');
            }
          } catch (error) {
            console.error('Error importing Steam library:', error);
            alert('Failed to import Steam library. Please try again.');
          }
        });
      }
      
      const disconnectSteamBtn = document.getElementById('disconnectSteamBtn');
      if (disconnectSteamBtn) {
        disconnectSteamBtn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to disconnect your Steam account? This will remove all Steam data from your profile.')) {
            return;
          }
          
          try {
            // Disable button and show loading state
            disconnectSteamBtn.disabled = true;
            disconnectSteamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Disconnecting...';
            
            console.log('[Profile] Disconnecting Steam account...');
            const response = await fetch('/api/auth/steam/unlink', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            const data = await response.json();
            console.log('[Profile] Disconnect response:', data);
            
            if (response.ok && data.success) {
              alert('Steam account disconnected successfully!');
              // Reload page to show updated profile
              window.location.reload();
            } else {
              alert(data.error || 'Failed to disconnect Steam account');
              // Re-enable button
              disconnectSteamBtn.disabled = false;
              disconnectSteamBtn.innerHTML = 'Disconnect Steam';
            }
          } catch (error) {
            console.error('[Profile] Error disconnecting Steam account:', error);
            alert('Failed to disconnect Steam account: ' + (error.message || 'Please try again.'));
            // Re-enable button
            disconnectSteamBtn.disabled = false;
            disconnectSteamBtn.innerHTML = 'Disconnect Steam';
          }
        });
      }
      
      // The app.js will handle session checking and show/hide login modal as needed
      
      // Steam Games List Functionality
      const toggleGamesListBtn = document.getElementById('toggleGamesList');
      const gamesListContainer = document.getElementById('gamesListContainer');
      const gamesSortSelect = document.getElementById('gamesSortSelect');
      const steamGamesGrid = document.getElementById('steamGamesGrid');
      
      if (toggleGamesListBtn && gamesListContainer) {
        let isCollapsed = false;
        
        toggleGamesListBtn.addEventListener('click', () => {
          isCollapsed = !isCollapsed;
          gamesListContainer.classList.toggle('collapsed', isCollapsed);
          
          if (isCollapsed) {
            toggleGamesListBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Expand';
          } else {
            toggleGamesListBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
          }
        });
      }
      
      // Achievements toggle functionality
      const toggleAchievementsListBtn = document.getElementById('toggleAchievementsList');
      const achievementsListContainer = document.getElementById('achievementsListContainer');
      
      if (toggleAchievementsListBtn && achievementsListContainer) {
        let achievementsCollapsed = false;
        
        toggleAchievementsListBtn.addEventListener('click', () => {
          achievementsCollapsed = !achievementsCollapsed;
          achievementsListContainer.classList.toggle('collapsed', achievementsCollapsed);
          
          if (achievementsCollapsed) {
            toggleAchievementsListBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Expand';
          } else {
            toggleAchievementsListBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
          }
        });
      }
      
      // Sorting functionality
      if (gamesSortSelect && steamGamesGrid) {
        const showPlaytimeForSort = (sortValue) => {
          const gameCards = steamGamesGrid.querySelectorAll('.steam-game-card');
          const shouldShow = sortValue === 'playtime-desc' || sortValue === 'playtime-asc';
          
          gameCards.forEach(card => {
            const playtimeElement = card.querySelector('.game-playtime');
            if (playtimeElement) {
              playtimeElement.style.display = shouldShow ? 'flex' : 'none';
            }
          });
        };
        
        gamesSortSelect.addEventListener('change', () => {
          const sortValue = gamesSortSelect.value;
          const gameCards = Array.from(steamGamesGrid.querySelectorAll('.steam-game-card'));
          
          if (gameCards.length === 0) {
            console.log('No game cards found for sorting');
            return;
          }
          
          gameCards.sort((a, b) => {
            if (sortValue === 'name-asc') {
              return a.dataset.name.localeCompare(b.dataset.name);
            } else if (sortValue === 'name-desc') {
              return b.dataset.name.localeCompare(a.dataset.name);
            } else if (sortValue === 'playtime-desc') {
              return parseInt(b.dataset.playtime || 0) - parseInt(a.dataset.playtime || 0);
            } else if (sortValue === 'playtime-asc') {
              return parseInt(a.dataset.playtime || 0) - parseInt(b.dataset.playtime || 0);
            }
            return 0;
          });
          
          // Clear and re-append sorted cards
          gameCards.forEach(card => steamGamesGrid.appendChild(card));
          
          // Show/hide playtime based on sort
          showPlaytimeForSort(sortValue);
        });
        
        // Check initial sort value on page load
        showPlaytimeForSort(gamesSortSelect.value);
      }
      
      // Avatar upload functionality
      const avatarUpload = document.getElementById('avatarUpload');
      if (avatarUpload) {
        avatarUpload.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          // Validate file size (5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            e.target.value = '';
            return;
          }
          
          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            e.target.value = '';
            return;
          }
          
          // Show loading state
          const avatarImg = document.getElementById('profileAvatarImg');
          const avatarIcon = document.querySelector('.profile-avatar i');
          const originalSrc = avatarImg ? avatarImg.src : null;
          
          // Create FormData
          const formData = new FormData();
          formData.append('avatar', file);
          
          try {
            const response = await fetch('/api/profile/avatar', {
              method: 'POST',
              body: formData,
              credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
              // Update avatar image
              if (avatarImg) {
                avatarImg.src = data.avatar_path + '?t=' + Date.now(); // Add cache busting
              } else {
                // Replace placeholder with uploaded image
                const avatarContainer = document.querySelector('.profile-avatar');
                if (avatarContainer) {
                  const existingImg = avatarContainer.querySelector('img');
                  if (existingImg) {
                    existingImg.src = data.avatar_path + '?t=' + Date.now();
                  } else {
                    const newImg = document.createElement('img');
                    newImg.src = data.avatar_path + '?t=' + Date.now();
                    newImg.alt = 'Profile Avatar';
                    newImg.id = 'profileAvatarImg';
                    newImg.className = 'avatar-image';
                    avatarContainer.insertBefore(newImg, avatarContainer.firstChild);
                  }
                }
              }
              console.log('Avatar uploaded successfully');
            } else {
              alert(data.error || 'Failed to upload avatar');
              // Restore original if available
              if (avatarImg && originalSrc) {
                avatarImg.src = originalSrc;
              }
            }
          } catch (error) {
            console.error('Error uploading avatar:', error);
            alert('Failed to upload avatar. Please try again.');
            // Restore original if available
            if (avatarImg && originalSrc) {
              avatarImg.src = originalSrc;
            }
          } finally {
            // Reset file input
            e.target.value = '';
          }
        });
      }
    });
  </script>
</body>
</html>
