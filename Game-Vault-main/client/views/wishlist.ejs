<!DOCTYPE html>
<html lang="en">
  <%- include('partials/head', { pageTitle: 'My Wishlist' }) %>
<body>
  <%- include('partials/header') %>

  <div class="container">
    <main class="main-content">
      <!-- Wishlist Section -->
      <section id="wishlistSection" class="content-section active">
        <div class="section-header">
          <h2><i class="fas fa-heart"></i> My Wishlist</h2>
          <div class="library-actions">
            <button class="btn btn-secondary" onclick="window.location.href='/library'">
              <i class="fas fa-arrow-left"></i> Back to Libraries
            </button>
            <button id="checkSteamOwnershipBtn" class="btn btn-steam">
              <i class="fab fa-steam"></i> Check Steam Ownership
            </button>
          </div>
        </div>
        
        <!-- Steam Ownership Status -->
        <div id="steamOwnershipStatus" class="steam-ownership-status" style="display: none;">
          <div class="ownership-header">
            <h3><i class="fab fa-steam"></i> Steam Ownership Status</h3>
            <span id="steamOwnershipCount" class="ownership-count">0 games owned</span>
          </div>
          <div id="steamOwnedGamesList" class="steam-owned-games">
            <!-- Steam owned games will be populated here -->
          </div>
        </div>

        <!-- Wishlist Games -->
        <div id="wishlistGames" class="list-container">
          <div class="empty-state">
            <i class="fas fa-heart"></i>
            <h3>Loading...</h3>
            <p>Please wait while we load your wishlist.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <%- include('partials/loginModal') %>

  <script src="/app.js?v=2"></script>
  <script>
    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Wishlist page - DOM Content Loaded');
      
      // Wait for app to initialize
      if (window.app) {
        // Check auth status first
        await window.app.checkAuthStatus();
        
        // If user is logged in, load wishlist
        if (window.app.currentUser) {
          await loadWishlist();
        } else {
          showLoginRequired();
        }
      } else {
        // Wait a bit for app to initialize
        setTimeout(async () => {
          if (window.app) {
            await window.app.checkAuthStatus();
            if (window.app.currentUser) {
              await loadWishlist();
            } else {
              showLoginRequired();
            }
          }
        }, 500);
      }
      
      // Add event listener for Steam ownership check button
      const checkSteamOwnershipBtn = document.getElementById('checkSteamOwnershipBtn');
      if (checkSteamOwnershipBtn) {
        checkSteamOwnershipBtn.addEventListener('click', async () => {
          if (window.app && window.app.currentUser) {
            try {
              const result = await window.checkWishlistSteamOwnership(window.app.currentUser.username);
              if (result) {
                displaySteamOwnershipStatus(result);
              } else {
                if (window.app) {
                  window.app.showAlert('Failed to check Steam ownership. Make sure you have a Steam account linked.', 'Error', 'error');
                } else {
                  alert('Failed to check Steam ownership. Make sure you have a Steam account linked.');
                }
              }
            } catch (error) {
              console.error('Error checking Steam ownership:', error);
              if (window.app) {
                window.app.showAlert('Error checking Steam ownership', 'Error', 'error');
              } else {
                alert('Error checking Steam ownership');
              }
            }
          } else {
            if (window.app) {
              window.app.showAlert('Please log in to check Steam ownership', 'Login Required', 'warning');
            } else {
              alert('Please log in to check Steam ownership');
            }
          }
        });
      }
    });

    async function loadWishlist() {
      const wishlistGames = document.getElementById('wishlistGames');
      if (!wishlistGames) return;

      try {
        // Get user's libraries
        const response = await fetch(`/api/wishlists/${window.app.currentUser.username}`, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        if (!data.success || !data.wishlists) {
          wishlistGames.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error</h3><p>Failed to load wishlist. Please try again.</p></div>';
          return;
        }

        // Find the wishlist library
        const wishlistLib = data.wishlists.find(lib => lib.type === 'wishlist');
        if (!wishlistLib) {
          wishlistGames.innerHTML = '<div class="empty-state"><i class="fas fa-heart"></i><h3>No Wishlist Found</h3><p>Your wishlist library will be created automatically when you add your first game.</p></div>';
          return;
        }

        // Load games from the wishlist
        const gamesResponse = await fetch(`/api/wishlists/${window.app.currentUser.username}/${wishlistLib.id}/games`, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });

        const gamesData = await gamesResponse.json();
        if (!gamesData.success || !gamesData.games) {
          wishlistGames.innerHTML = '<div class="empty-state"><i class="fas fa-heart"></i><h3>No Games in Wishlist</h3><p>Add games to your wishlist from the search page!</p></div>';
          return;
        }

        const games = gamesData.games;
        if (games.length === 0) {
          wishlistGames.innerHTML = '<div class="empty-state"><i class="fas fa-heart"></i><h3>Your Wishlist is Empty</h3><p>Add games to your wishlist from the search page!</p></div>';
          return;
        }

        // Render games
        wishlistGames.innerHTML = games.map(game => `
          <div class="wishlist-game-item">
            <div class="game-info">
              <h3>${game.title || game.gameTitle || 'Unknown Game'}</h3>
              ${game.platform ? `<p class="game-platform"><i class="fas fa-gamepad"></i> ${game.platform}</p>` : ''}
              ${game.notes ? `<p class="game-notes">${game.notes}</p>` : ''}
              <p class="game-added">Added: ${new Date(game.addedDate || game.createdAt).toLocaleDateString()}</p>
            </div>
            <div class="game-actions">
              ${game.steamId ? `<a href="https://store.steampowered.com/app/${game.steamId}" target="_blank" class="btn btn-steam btn-sm"><i class="fab fa-steam"></i> View on Steam</a>` : ''}
              <button class="btn btn-danger btn-sm" onclick="removeFromWishlist(${game.id || game.gameId}, '${(game.title || game.gameTitle || '').replace(/'/g, "\\'")}')">
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading wishlist:', error);
        wishlistGames.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error</h3><p>Failed to load wishlist. Please try again.</p></div>';
      }
    }

    function showLoginRequired() {
      const wishlistGames = document.getElementById('wishlistGames');
      if (wishlistGames) {
        wishlistGames.innerHTML = '<div class="empty-state"><i class="fas fa-lock"></i><h3>Login Required</h3><p>Please log in to view your wishlist!</p></div>';
      }
    }

    async function removeFromWishlist(gameId, gameTitle) {
      if (!window.app || !window.app.currentUser) {
        if (window.app) {
          window.app.showAlert('Please log in to remove games', 'Login Required', 'warning');
        }
        return;
      }

      if (!confirm(`Are you sure you want to remove "${gameTitle}" from your wishlist?`)) {
        return;
      }

      try {
        // Get wishlist library ID
        const response = await fetch(`/api/wishlists/${window.app.currentUser.username}`, {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        if (!data.success || !data.wishlists) {
          throw new Error('Failed to get wishlist');
        }

        const wishlistLib = data.wishlists.find(lib => lib.type === 'wishlist');
        if (!wishlistLib) {
          throw new Error('Wishlist library not found');
        }

        // Remove game from wishlist
        const removeResponse = await fetch(`/api/wishlists/${window.app.currentUser.username}/remove-game`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wishlistId: wishlistLib.id,
            gameId: gameId
          })
        });

        const removeData = await removeResponse.json();
        if (removeData.success) {
          if (window.app) {
            window.app.showAlert('Game removed from wishlist', 'Success', 'success');
          }
          // Reload wishlist
          await loadWishlist();
        } else {
          throw new Error(removeData.error || 'Failed to remove game');
        }
      } catch (error) {
        console.error('Error removing game from wishlist:', error);
        if (window.app) {
          window.app.showAlert('Failed to remove game from wishlist', 'Error', 'error');
        } else {
          alert('Failed to remove game from wishlist');
        }
      }
    }

    function displaySteamOwnershipStatus(result) {
      const statusDiv = document.getElementById('steamOwnershipStatus');
      const countSpan = document.getElementById('steamOwnershipCount');
      const gamesList = document.getElementById('steamOwnedGamesList');

      if (statusDiv && countSpan && gamesList) {
        statusDiv.style.display = 'block';
        countSpan.textContent = `${result.totalOwned} games owned`;

        if (result.steamOwnedGames.length > 0) {
          gamesList.innerHTML = result.steamOwnedGames.map(game => `
            <div class="steam-owned-game">
              <span class="game-name">${game.gameName}</span>
              <span class="wishlist-name">in ${game.wishlistName}</span>
              <a href="steam://run/${game.gameId}" class="btn btn-steam btn-sm">
                <i class="fab fa-steam"></i> Play
              </a>
            </div>
          `).join('');
        } else {
          gamesList.innerHTML = '<p class="no-owned-games">No wishlisted games found in your Steam library.</p>';
        }
      }
    }
  </script>
</body>
</html>
