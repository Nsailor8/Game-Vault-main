<!DOCTYPE html>
<html lang="en">
  <%- include('partials/head', { pageTitle: 'Wishlist' }) %>
<body>
  <%- include('partials/header') %>

  <div class="container">
    <main class="main-content">
      <!-- Wishlist Section -->
      <section id="wishlistSection" class="content-section active">
        <div class="section-header">
          <h2>Wishlist</h2>
          <div class="wishlist-actions">
            <button id="checkSteamOwnershipBtn" class="btn btn-steam">
              <i class="fab fa-steam"></i> Check Steam Ownership
            </button>
            <button id="addWishlistBtn" class="btn btn-primary">Add Game</button>
          </div>
        </div>
        <!-- Steam Ownership Status -->
        <div id="steamOwnershipStatus" class="steam-ownership-status" style="display: none;">
          <div class="ownership-header">
            <h3><i class="fab fa-steam"></i> Steam Ownership Status</h3>
            <span id="steamOwnershipCount" class="ownership-count">0 games owned</span>
          </div>
          <div id="steamOwnedGamesList" class="steam-owned-games">
            <!-- Steam owned games will be populated here -->
          </div>
        </div>

        <div class="wishlists-content">
          <!-- Wishlists List -->
          <div id="wishlistContainer" class="list-container">
            <!-- Wishlist items will be populated here by JavaScript -->
            <div class="empty-state">
              <i class="fas fa-heart"></i>
              <h3>Loading...</h3>
              <p>Please wait while we load your wishlist.</p>
            </div>
          </div>
          
          <!-- Selected Wishlist Games -->
          <div id="selectedWishlistSection" style="display: none; margin-top: 2rem;">
            <div class="section-header">
              <h3 id="selectedWishlistTitle">Wishlist Games</h3>
              <button class="btn btn-secondary" onclick="if(window.app) window.app.backToWishlists();">
                <i class="fas fa-arrow-left"></i> Back to Wishlists
              </button>
            </div>
            <div id="wishlistGames" class="list-container">
              <!-- Games will be populated here when a wishlist is selected -->
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <%- include('partials/loginModal') %>

  <script src="/app.js"></script>
  <script>
    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Wishlist page - DOM Content Loaded');
      
      // Wait for app to initialize
      if (window.app) {
        // Check auth status first
        await window.app.checkAuthStatus();
        
        // If user is logged in, update wishlists
        if (window.app.currentUser) {
          window.app.updateWishlists();
        }
      } else {
        // Wait a bit for app to initialize
        setTimeout(async () => {
          if (window.app) {
            await window.app.checkAuthStatus();
            if (window.app.currentUser) {
              window.app.updateWishlists();
            }
          }
        }, 500);
      }
      
      // Add event listener for Steam ownership check button
      const checkSteamOwnershipBtn = document.getElementById('checkSteamOwnershipBtn');
      if (checkSteamOwnershipBtn) {
        checkSteamOwnershipBtn.addEventListener('click', async () => {
          if (window.app && window.app.currentUser) {
            try {
              const result = await window.checkWishlistSteamOwnership(window.app.currentUser.username);
              if (result) {
                displaySteamOwnershipStatus(result);
              } else {
                if (window.app) {
                  window.app.showAlert('Failed to check Steam ownership. Make sure you have a Steam account linked.', 'Error', 'error');
                } else {
                  alert('Failed to check Steam ownership. Make sure you have a Steam account linked.');
                }
              }
            } catch (error) {
              console.error('Error checking Steam ownership:', error);
              if (window.app) {
                window.app.showAlert('Error checking Steam ownership', 'Error', 'error');
              } else {
                alert('Error checking Steam ownership');
              }
            }
          } else {
            if (window.app) {
              window.app.showAlert('Please log in to check Steam ownership', 'Login Required', 'warning');
            } else {
              alert('Please log in to check Steam ownership');
            }
          }
        });
      }
      
      // Add event listener for Add Game button
      const addWishlistBtn = document.getElementById('addWishlistBtn');
      if (addWishlistBtn) {
        addWishlistBtn.addEventListener('click', () => {
          // Redirect to search page to find games to add
          window.location.href = '/search';
        });
      }
    });

    function displaySteamOwnershipStatus(result) {
      const statusDiv = document.getElementById('steamOwnershipStatus');
      const countSpan = document.getElementById('steamOwnershipCount');
      const gamesList = document.getElementById('steamOwnedGamesList');

      if (statusDiv && countSpan && gamesList) {
        statusDiv.style.display = 'block';
        countSpan.textContent = `${result.totalOwned} games owned`;

        if (result.steamOwnedGames.length > 0) {
          gamesList.innerHTML = result.steamOwnedGames.map(game => `
            <div class="steam-owned-game">
              <span class="game-name">${game.gameName}</span>
              <span class="wishlist-name">in ${game.wishlistName}</span>
              <a href="steam://run/${game.gameId}" class="btn btn-steam btn-sm">
                <i class="fab fa-steam"></i> Play
              </a>
            </div>
          `).join('');
        } else {
          gamesList.innerHTML = '<p class="no-owned-games">No wishlisted games found in your Steam library.</p>';
        }
      }
    }
  </script>
</body>
</html>
